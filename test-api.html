<!DOCTYPE html>
<html>
<head>
    <title>API Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        button { padding: 10px 20px; margin: 5px; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Sub-Store API 测试</h1>
    
    <div>
        <button onclick="testHealth()">测试健康检查</button>
        <button onclick="testLogin()">测试登录</button>
        <button onclick="testLoginWithWorkersDomain()">测试登录(Workers域名)</button>
        <button onclick="testCurrentLogin()">测试当前登录问题</button>
    </div>
    
    <div id="results"></div>

    <script>
        function addResult(title, content, isSuccess = true) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${isSuccess ? 'success' : 'error'}`;
            div.innerHTML = `<h3>${title}</h3><pre>${content}</pre>`;
            results.appendChild(div);
        }

        async function testHealth() {
            try {
                addResult('健康检查', '正在测试 sub-api.senma.io...', true);

                const response = await fetch('https://sub-api.senma.io/health');
                const data = await response.text();

                addResult('健康检查结果', `状态码: ${response.status}\n响应: ${data}`, response.ok);
            } catch (error) {
                addResult('健康检查错误', error.message, false);
            }
        }

        async function testLogin() {
            try {
                addResult('登录测试', '正在测试 sub-api.senma.io...', true);
                
                const response = await fetch('https://sub-api.senma.io/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'Sz@2400104'
                    })
                });
                
                const data = await response.json();
                
                addResult('登录结果', 
                    `状态码: ${response.status}\n` +
                    `响应: ${JSON.stringify(data, null, 2)}\n` +
                    `Token存在: ${!!(data.data && data.data.token)}\n` +
                    `Token长度: ${data.data && data.data.token ? data.data.token.length : 'N/A'}`,
                    response.ok && data.success
                );
            } catch (error) {
                addResult('登录错误', error.message, false);
            }
        }

        async function testLoginWithWorkersDomain() {
            try {
                addResult('登录测试(Workers)', '正在测试 substore-api.senmago231.workers.dev...', true);
                
                const response = await fetch('https://substore-api.senmago231.workers.dev/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'Sz@2400104'
                    })
                });
                
                const data = await response.json();
                
                addResult('登录结果(Workers)', 
                    `状态码: ${response.status}\n` +
                    `响应: ${JSON.stringify(data, null, 2)}\n` +
                    `Token存在: ${!!(data.data && data.data.token)}\n` +
                    `Token长度: ${data.data && data.data.token ? data.data.token.length : 'N/A'}`,
                    response.ok && data.success
                );
            } catch (error) {
                addResult('登录错误(Workers)', error.message, false);
            }
        }

        async function testCurrentLogin() {
            try {
                addResult('当前登录问题诊断', '正在诊断反爬机制对登录的影响...', true);

                // 测试1: 正常浏览器请求
                const response1 = await fetch('https://sub-api.senma.io/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'User-Agent': navigator.userAgent
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'Sz@2400104'
                    })
                });

                const data1 = await response1.json();

                addResult('浏览器登录测试',
                    `状态码: ${response1.status}\n` +
                    `User-Agent: ${navigator.userAgent}\n` +
                    `响应: ${JSON.stringify(data1, null, 2)}\n` +
                    `Token存在: ${!!(data1.data && data1.data.token)}\n` +
                    `Token内容: ${data1.data && data1.data.token ? (data1.data.token === '[REDACTED]' ? '被过滤了!' : '正常') : 'N/A'}`,
                    response1.ok && data1.success
                );

                // 测试2: 模拟可疑User-Agent
                const response2 = await fetch('https://sub-api.senma.io/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'User-Agent': 'curl/7.68.0'
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'Sz@2400104'
                    })
                });

                const data2 = await response2.json();

                addResult('可疑UA登录测试',
                    `状态码: ${response2.status}\n` +
                    `User-Agent: curl/7.68.0\n` +
                    `响应: ${JSON.stringify(data2, null, 2)}\n` +
                    `是否被反爬拦截: ${response2.status !== 200 || !data2.success}`,
                    true // 这个测试总是显示为信息性的
                );

            } catch (error) {
                addResult('登录诊断错误', error.message, false);
            }
        }

        // 页面加载时自动测试
        window.onload = function() {
            addResult('页面加载', '测试页面已加载，点击按钮开始测试', true);
            addResult('问题说明', '当前登录问题是由反爬机制导致的，正在测试修复效果...', true);
        };
    </script>
</body>
</html>
