name: Deploy Sub-Store

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  # æ„å»ºå’Œæµ‹è¯•
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install workers dependencies
      run: |
        cd workers
        npm install

    - name: Type check workers
      run: |
        cd workers
        npm run type-check

    - name: Build workers
      run: |
        cd workers
        npm run build

    - name: Install frontend dependencies
      run: |
        cd frontend
        npm install

    - name: Build frontend
      run: |
        cd frontend
        npm run build

  # éƒ¨ç½² Cloudflare Workers
  deploy-workers:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install workers dependencies
      run: cd workers && npm install

    # é…ç½® D1 æ•°æ®åº“ - ä½¿ç”¨ GitHub Secrets åŠ¨æ€æ³¨å…¥é…ç½®
    - name: Configure D1 Database
      run: |
        cd workers
        echo "ğŸ—„ï¸ é…ç½® D1 æ•°æ®åº“..."

        # æ£€æŸ¥å¿…è¦çš„ secrets æ˜¯å¦å­˜åœ¨
        if [ -z "${{ secrets.CF_D1_DATABASE_ID }}" ] || [ -z "${{ secrets.CF_D1_DATABASE_NAME }}" ]; then
          echo "âŒ ç¼ºå°‘å¿…è¦çš„æ•°æ®åº“é…ç½® secrets"
          echo "è¯·ç¡®ä¿å·²è®¾ç½® CF_D1_DATABASE_ID å’Œ CF_D1_DATABASE_NAME"
          exit 1
        fi

        # æ›´æ–° wrangler.toml ä¸­çš„æ•°æ®åº“é…ç½®
        sed -i 's/YOUR_REAL_DATABASE_ID_HERE/${{ secrets.CF_D1_DATABASE_ID }}/' wrangler.toml
        sed -i 's/sub-store-db/${{ secrets.CF_D1_DATABASE_NAME }}/' wrangler.toml

        echo "âœ… D1 æ•°æ®åº“é…ç½®å®Œæˆ"
        echo "ğŸ“‹ å½“å‰é…ç½®ï¼š"
        grep -A 5 "d1_databases" wrangler.toml || echo "é…ç½®æœªæ‰¾åˆ°"

    - name: Run D1 Database Migrations
      uses: cloudflare/wrangler-action@v3
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        workingDirectory: workers
        command: d1 execute ${{ secrets.CF_D1_DATABASE_NAME }} --file=./schema.sql
      continue-on-error: true

    - name: Deploy to Cloudflare Workers
      uses: cloudflare/wrangler-action@v3
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        workingDirectory: workers
        command: deploy --compatibility-date=2024-01-15
        secrets: |
          ADMIN_TOKEN
          JWT_SECRET
      env:
        # ç®¡ç†å‘˜è®¤è¯é…ç½®
        ADMIN_TOKEN: ${{ secrets.ADMIN_TOKEN }}
        # JWT å¯†é’¥ï¼ˆå¯é€‰ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆï¼‰
        JWT_SECRET: ${{ secrets.JWT_SECRET }}

  # éƒ¨ç½²å‰ç«¯åˆ° Cloudflare Pages
  deploy-frontend:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install frontend dependencies
      run: cd frontend && npm install

    - name: Build frontend
      run: cd frontend && npm run build

    - name: Deploy to Cloudflare Pages
      uses: cloudflare/wrangler-action@v3
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        workingDirectory: frontend
        command: pages deploy dist --project-name=sub-store-frontend

  # å¥åº·æ£€æŸ¥
  health-check:
    needs: [deploy-workers, deploy-frontend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'

    steps:
    - name: Wait for deployment
      run: sleep 30

    - name: Health check - API
      run: |
        echo "æ£€æŸ¥ Workers API éƒ¨ç½²çŠ¶æ€..."
        curl -f https://sub-api.senma.io/health || echo "âš ï¸ API å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ"

    - name: Health check - Frontend
      run: |
        echo "æ£€æŸ¥å‰ç«¯éƒ¨ç½²çŠ¶æ€..."
        curl -f https://sub.senma.io/ || echo "âš ï¸ å‰ç«¯å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ"

    - name: Notify deployment success
      if: success()
      run: |
        echo "âœ… Deployment successful!"
        echo "ğŸŒ Frontend: https://sub.senma.io"
        echo "ğŸ”§ API: https://sub-api.senma.io"
        echo "ğŸ“Š Architecture: Cloudflare Workers + D1 + Pages"
