<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-UI Bridge 测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #1890ff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #40a9ff;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            background-color: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }
        .error {
            background-color: #fff2f0;
            border: 1px solid #ffccc7;
            color: #ff4d4f;
        }
        .info {
            background-color: #f0f9ff;
            border: 1px solid #91d5ff;
            color: #1890ff;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e8e8e8;
            border-radius: 6px;
        }
        .section h3 {
            margin-top: 0;
            color: #1890ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>X-UI Bridge 服务测试</h1>
        <p>测试VPS上的X-UI Bridge服务和Sub-Store后端的集成</p>
        
        <div class="section">
            <h3>1. Bridge服务健康检查</h3>
            <button onclick="testBridgeHealth()">测试Bridge健康状态</button>
            <div id="healthResult"></div>
        </div>

        <div class="section">
            <h3>2. Bridge服务API测试</h3>
            <div class="form-group">
                <label for="xuiUrl">X-UI面板地址:</label>
                <input type="text" id="xuiUrl" value="https://example.com:54321" placeholder="https://your-xui-panel.com:port">
            </div>
            <div class="form-group">
                <label for="xuiUsername">用户名:</label>
                <input type="text" id="xuiUsername" value="admin">
            </div>
            <div class="form-group">
                <label for="xuiPassword">密码:</label>
                <input type="password" id="xuiPassword" value="password">
            </div>
            <button onclick="testBridgeConnection()">测试Bridge连接</button>
            <button onclick="testBridgeSync()">测试Bridge同步</button>
            <div id="bridgeResult"></div>
        </div>

        <div class="section">
            <h3>3. Sub-Store后端集成测试</h3>
            <div class="form-group">
                <label for="token">认证Token:</label>
                <input type="text" id="token" placeholder="Bearer token (从登录获取)">
            </div>
            <button onclick="testSubStoreIntegration()">测试后端集成</button>
            <div id="integrationResult"></div>
        </div>
    </div>

    <script>
        const BRIDGE_URL = 'http://141.11.91.40:3002';
        const API_BASE_URL = 'https://sub-api.senma.io';
        
        // 测试Bridge服务健康状态
        async function testBridgeHealth() {
            const resultDiv = document.getElementById('healthResult');
            resultDiv.innerHTML = '<div class="info">正在检查Bridge服务健康状态...</div>';
            
            try {
                const response = await fetch(`${BRIDGE_URL}/health`);
                const result = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `<div class="success">✅ Bridge服务运行正常
                    
服务状态: ${result.status}
服务名称: ${result.service}
时间戳: ${result.timestamp}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="error">❌ Bridge服务异常
                    
状态码: ${response.status}
响应: ${JSON.stringify(result, null, 2)}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ 无法连接到Bridge服务
                
错误: ${error.message}
Bridge地址: ${BRIDGE_URL}</div>`;
            }
        }
        
        // 测试Bridge连接功能
        async function testBridgeConnection() {
            const resultDiv = document.getElementById('bridgeResult');
            const url = document.getElementById('xuiUrl').value;
            const username = document.getElementById('xuiUsername').value;
            const password = document.getElementById('xuiPassword').value;
            
            if (!url || !username || !password) {
                resultDiv.innerHTML = '<div class="error">请填写完整的X-UI面板信息</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="info">正在测试Bridge连接...</div>';
            
            try {
                const response = await fetch(`${BRIDGE_URL}/api/xui/test`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url, username, password })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    resultDiv.innerHTML = `<div class="success">✅ Bridge连接测试成功
                    
${JSON.stringify(result, null, 2)}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="error">❌ Bridge连接测试失败
                    
错误: ${result.error || result.message || '未知错误'}
状态码: ${response.status}
响应: ${JSON.stringify(result, null, 2)}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ Bridge连接测试网络错误
                
错误: ${error.message}</div>`;
            }
        }
        
        // 测试Bridge同步功能
        async function testBridgeSync() {
            const resultDiv = document.getElementById('bridgeResult');
            const url = document.getElementById('xuiUrl').value;
            const username = document.getElementById('xuiUsername').value;
            const password = document.getElementById('xuiPassword').value;
            
            if (!url || !username || !password) {
                resultDiv.innerHTML = '<div class="error">请填写完整的X-UI面板信息</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="info">正在测试Bridge同步...</div>';
            
            try {
                const response = await fetch(`${BRIDGE_URL}/api/xui/sync`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url, username, password })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    resultDiv.innerHTML = `<div class="success">✅ Bridge同步测试成功
                    
${JSON.stringify(result, null, 2)}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="error">❌ Bridge同步测试失败
                    
错误: ${result.error || result.message || '未知错误'}
状态码: ${response.status}
响应: ${JSON.stringify(result, null, 2)}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ Bridge同步测试网络错误
                
错误: ${error.message}</div>`;
            }
        }
        
        // 测试Sub-Store后端集成
        async function testSubStoreIntegration() {
            const resultDiv = document.getElementById('integrationResult');
            const token = document.getElementById('token').value;
            const url = document.getElementById('xuiUrl').value;
            const username = document.getElementById('xuiUsername').value;
            const password = document.getElementById('xuiPassword').value;
            
            if (!token) {
                resultDiv.innerHTML = '<div class="error">请先获取认证Token</div>';
                return;
            }
            
            if (!url || !username || !password) {
                resultDiv.innerHTML = '<div class="error">请填写完整的X-UI面板信息</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="info">正在测试Sub-Store后端集成...</div>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/xui-panels/test`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ 
                        url, 
                        username, 
                        password,
                        bridgeUrl: BRIDGE_URL
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    resultDiv.innerHTML = `<div class="success">✅ Sub-Store后端集成测试成功
                    
${JSON.stringify(result, null, 2)}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="error">❌ Sub-Store后端集成测试失败
                    
错误: ${result.error || result.message || '未知错误'}
状态码: ${response.status}
响应: ${JSON.stringify(result, null, 2)}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ Sub-Store后端集成测试网络错误
                
错误: ${error.message}</div>`;
            }
        }
        
        // 页面加载时自动测试Bridge健康状态
        window.onload = function() {
            testBridgeHealth();
        };
    </script>
</body>
</html>
