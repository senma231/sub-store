# Sub-Store çº¯ç½‘é¡µéƒ¨ç½²æ•™ç¨‹

## ğŸŒ æ— éœ€å®‰è£…ä»»ä½•è½¯ä»¶ï¼Œçº¯ç½‘é¡µæ“ä½œéƒ¨ç½²

æœ¬æ•™ç¨‹å°†æŒ‡å¯¼æ‚¨å®Œå…¨é€šè¿‡ç½‘é¡µç•Œé¢éƒ¨ç½² Sub-Storeï¼Œæ— éœ€å®‰è£… Node.jsã€Wrangler CLI ç­‰å·¥å…·ã€‚

---

## ğŸ“‹ å‡†å¤‡å·¥ä½œ

### å¿…éœ€è´¦æˆ·
- âœ… GitHub è´¦æˆ·
- âœ… Cloudflare è´¦æˆ·

### é¢„è®¡æ—¶é—´
- **é¦–æ¬¡éƒ¨ç½²**: 30-40 åˆ†é’Ÿ
- **ç†Ÿç»ƒå**: 10-15 åˆ†é’Ÿ

---

## ğŸ”§ ç¬¬ä¸€æ­¥ï¼šCloudflare é…ç½®

### 1.1 æ³¨å†Œ Cloudflare è´¦æˆ·

1. **è®¿é—® Cloudflare**
   - æ‰“å¼€ https://cloudflare.com
   - ç‚¹å‡» "Sign Up" æ³¨å†Œè´¦æˆ·

2. **éªŒè¯é‚®ç®±**
   - æ£€æŸ¥é‚®ç®±éªŒè¯é“¾æ¥
   - å®Œæˆè´¦æˆ·æ¿€æ´»

### 1.2 è·å– Account ID

1. **ç™»å½• Dashboard**
   - è®¿é—® https://dash.cloudflare.com
   - ä½¿ç”¨åˆšæ³¨å†Œçš„è´¦æˆ·ç™»å½•

2. **å¤åˆ¶ Account ID**
   - åœ¨å³ä¾§è¾¹æ æ‰¾åˆ° "Account ID"
   - ç‚¹å‡»å¤åˆ¶æŒ‰é’®
   - **ä¿å­˜åˆ°è®°äº‹æœ¬**ï¼Œæ ‡è®°ä¸º "Account ID"

### 1.3 åˆ›å»º API Token

1. **è¿›å…¥ API Token é¡µé¢**
   - ç‚¹å‡»å³ä¸Šè§’å¤´åƒ
   - é€‰æ‹© "My Profile"
   - ç‚¹å‡» "API Tokens" æ ‡ç­¾

2. **åˆ›å»ºè‡ªå®šä¹‰ Token**
   - ç‚¹å‡» "Create Token"
   - é€‰æ‹© "Custom token"

3. **é…ç½®æƒé™**ï¼ˆé‡è¦ï¼šå¿…é¡»ç²¾ç¡®é…ç½®ï¼‰
   ```
   Token name: Sub-Store-Deploy
   
   Permissions:
   âœ… Account | Cloudflare Workers:Edit
   âœ… Account | Cloudflare Pages:Edit
   âœ… Account | D1:Edit
   
   Account Resources:
   âœ… Include | All accounts
   
   TTL: 1 year
   ```

4. **ç”Ÿæˆå¹¶ä¿å­˜ Token**
   - ç‚¹å‡» "Continue to summary"
   - ç‚¹å‡» "Create Token"
   - **å¤åˆ¶å¹¶ä¿å­˜ Token**ï¼Œæ ‡è®°ä¸º "API Token"

### 1.4 åˆ›å»º D1 æ•°æ®åº“

1. **è¿›å…¥ D1 é¡µé¢**
   - åœ¨å·¦ä¾§èœå•ä¸­ç‚¹å‡» "D1"
   - ç‚¹å‡» "Create database"

2. **é…ç½®æ•°æ®åº“**
   - Database name: `sub-store-db`
   - ç‚¹å‡» "Create"

3. **è·å–æ•°æ®åº“ ID**
   - åˆ›å»ºæˆåŠŸåï¼Œå¤åˆ¶ Database ID
   - **ä¿å­˜åˆ°è®°äº‹æœ¬**ï¼Œæ ‡è®°ä¸º "D1 Database ID"

### 1.5 åˆå§‹åŒ–æ•°æ®åº“è¡¨ç»“æ„

1. **è¿›å…¥æ•°æ®åº“æ§åˆ¶å°**
   - ç‚¹å‡»åˆšåˆ›å»ºçš„æ•°æ®åº“
   - ç‚¹å‡» "Console" æ ‡ç­¾

2. **æ‰§è¡Œå»ºè¡¨ SQL**
   - å¤åˆ¶ä»¥ä¸‹ SQL ä»£ç ï¼š
   ```sql
   -- ç”¨æˆ·è¡¨
   CREATE TABLE IF NOT EXISTS users (
       id TEXT PRIMARY KEY,
       username TEXT UNIQUE NOT NULL,
       password TEXT NOT NULL,
       role TEXT DEFAULT 'user',
       email TEXT,
       created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
       updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
       last_login DATETIME,
       enabled BOOLEAN DEFAULT 1
   );

   -- ä»£ç†èŠ‚ç‚¹è¡¨
   CREATE TABLE IF NOT EXISTS nodes (
       id TEXT PRIMARY KEY,
       name TEXT NOT NULL,
       type TEXT NOT NULL,
       server TEXT NOT NULL,
       port INTEGER NOT NULL,
       enabled BOOLEAN DEFAULT 1,
       tags TEXT,
       remark TEXT,
       uuid TEXT,
       encryption TEXT,
       flow TEXT,
       alter_id INTEGER,
       security TEXT,
       password TEXT,
       method TEXT,
       username TEXT,
       network TEXT DEFAULT 'tcp',
       tls BOOLEAN DEFAULT 0,
       sni TEXT,
       alpn TEXT,
       fingerprint TEXT,
       allow_insecure BOOLEAN DEFAULT 0,
       ws_path TEXT,
       ws_headers TEXT,
       h2_path TEXT,
       h2_host TEXT,
       grpc_service_name TEXT,
       grpc_mode TEXT,
       plugin TEXT,
       plugin_opts TEXT,
       obfs TEXT,
       obfs_password TEXT,
       up_mbps INTEGER,
       down_mbps INTEGER,
       auth TEXT,
       auth_str TEXT,
       protocol TEXT,
       total_requests INTEGER DEFAULT 0,
       last_used DATETIME,
       created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
       updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
   );

   -- æ’å…¥é»˜è®¤ç®¡ç†å‘˜ç”¨æˆ·
   INSERT OR IGNORE INTO users (id, username, password, role) 
   VALUES ('admin', 'admin', 'change_me_on_first_deploy', 'admin');
   ```

3. **æ‰§è¡Œ SQL**
   - ç²˜è´´åˆ°æ§åˆ¶å°
   - ç‚¹å‡» "Execute" æ‰§è¡Œ
   - ç¡®è®¤æ˜¾ç¤ºæˆåŠŸä¿¡æ¯

---

## ğŸ™ ç¬¬äºŒæ­¥ï¼šGitHub é…ç½®

### 2.1 Fork é¡¹ç›®

1. **è®¿é—®åŸé¡¹ç›®**
   - æ‰“å¼€ https://github.com/senma231/sub-store

2. **Fork ä»“åº“**
   - ç‚¹å‡»å³ä¸Šè§’ "Fork" æŒ‰é’®
   - ç¡®è®¤ Fork åˆ°æ‚¨çš„è´¦æˆ·
   - ç­‰å¾… Fork å®Œæˆ

### 2.2 é…ç½® GitHub Secrets

1. **è¿›å…¥ Secrets è®¾ç½®**
   - åœ¨æ‚¨ Fork çš„ä»“åº“é¡µé¢
   - ç‚¹å‡» "Settings" æ ‡ç­¾
   - å·¦ä¾§èœå• â†’ "Secrets and variables" â†’ "Actions"

2. **æ·»åŠ  4 ä¸ªå¿…éœ€çš„ Secrets**

   **Secret 1: CLOUDFLARE_API_TOKEN**
   - ç‚¹å‡» "New repository secret"
   - Name: `CLOUDFLARE_API_TOKEN`
   - Secret: ç²˜è´´ä¹‹å‰ä¿å­˜çš„ API Token
   - ç‚¹å‡» "Add secret"

   **Secret 2: CLOUDFLARE_ACCOUNT_ID**
   - ç‚¹å‡» "New repository secret"
   - Name: `CLOUDFLARE_ACCOUNT_ID`
   - Secret: ç²˜è´´ä¹‹å‰ä¿å­˜çš„ Account ID
   - ç‚¹å‡» "Add secret"

   **Secret 3: API_BASE_URL**
   - ç‚¹å‡» "New repository secret"
   - Name: `API_BASE_URL`
   - Secret: `https://sub-store-api.æ‚¨çš„GitHubç”¨æˆ·å.workers.dev`
   - ä¾‹å¦‚ï¼š`https://sub-store-api.senma231.workers.dev`
   - ç‚¹å‡» "Add secret"

   **Secret 4: FRONTEND_URL**
   - ç‚¹å‡» "New repository secret"
   - Name: `FRONTEND_URL`
   - Secret: `https://sub-store-frontend.pages.dev`
   - ç‚¹å‡» "Add secret"

### 2.3 å¯ç”¨ GitHub Actions

1. **è¿›å…¥ Actions é¡µé¢**
   - ç‚¹å‡»ä»“åº“çš„ "Actions" æ ‡ç­¾
   - å¦‚æœçœ‹åˆ°å¯ç”¨æç¤ºï¼Œç‚¹å‡» "I understand my workflows, go ahead and enable them"

---

## âš™ï¸ ç¬¬ä¸‰æ­¥ï¼šé…ç½®é¡¹ç›®æ–‡ä»¶

### 3.1 æ›´æ–° wrangler.toml é…ç½®

1. **ç¼–è¾‘é…ç½®æ–‡ä»¶**
   - åœ¨ä»“åº“ä¸­æ‰¾åˆ° `workers/wrangler.toml` æ–‡ä»¶
   - ç‚¹å‡»æ–‡ä»¶åè¿›å…¥æŸ¥çœ‹
   - ç‚¹å‡»ç¼–è¾‘æŒ‰é’®ï¼ˆé“…ç¬”å›¾æ ‡ï¼‰

2. **æ›´æ–°æ•°æ®åº“é…ç½®**
   - æ‰¾åˆ° `[[d1_databases]]` éƒ¨åˆ†
   - å°† `database_id = "your_d1_database_id"` 
   - æ›¿æ¢ä¸ºæ‚¨çš„å®é™… D1 Database ID
   - ä¾‹å¦‚ï¼š`database_id = "12345678-1234-1234-1234-123456789abc"`

3. **æäº¤æ›´æ”¹**
   - æ»šåŠ¨åˆ°é¡µé¢åº•éƒ¨
   - Commit message: `Update D1 database configuration`
   - ç‚¹å‡» "Commit changes"

### 3.2 ç”Ÿæˆå®‰å…¨å¯†é’¥

1. **ç”Ÿæˆç®¡ç†å‘˜å¯†ç **
   - è®¿é—®åœ¨çº¿éšæœºå­—ç¬¦ä¸²ç”Ÿæˆå™¨ï¼šhttps://www.random.org/strings/
   - æˆ–ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ï¼š
     - æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰
     - è¾“å…¥ï¼š`crypto.getRandomValues(new Uint8Array(32)).reduce((a,b)=>a+b.toString(16).padStart(2,'0'),'')`
     - å¤åˆ¶ç”Ÿæˆçš„ 64 ä½å­—ç¬¦ä¸²
   - **ä¿å­˜ä¸ºç®¡ç†å‘˜å¯†ç **

2. **ç”Ÿæˆ JWT å¯†é’¥**
   - åŒæ ·æ–¹æ³•ç”Ÿæˆå¦ä¸€ä¸ª 64 ä½å­—ç¬¦ä¸²
   - **ä¿å­˜ä¸º JWT å¯†é’¥**

---

## ğŸš€ ç¬¬å››æ­¥ï¼šè§¦å‘è‡ªåŠ¨éƒ¨ç½²

### 4.1 åˆ›å»ºéƒ¨ç½²è§¦å‘æ–‡ä»¶

1. **åˆ›å»ºæ–°æ–‡ä»¶**
   - åœ¨ä»“åº“ä¸»é¡µç‚¹å‡» "Add file" â†’ "Create new file"
   - æ–‡ä»¶åï¼š`DEPLOY_TRIGGER.md`
   - å†…å®¹ï¼š
   ```markdown
   # éƒ¨ç½²è§¦å‘å™¨
   
   ä¿®æ”¹æ­¤æ–‡ä»¶å¯è§¦å‘è‡ªåŠ¨éƒ¨ç½²
   
   éƒ¨ç½²æ—¶é—´: 2024-01-01
   ```

2. **æäº¤æ–‡ä»¶**
   - Commit message: `Trigger deployment`
   - ç‚¹å‡» "Commit new file"

### 4.2 ç›‘æ§éƒ¨ç½²è¿›åº¦

1. **æŸ¥çœ‹ Actions æ‰§è¡Œ**
   - ç‚¹å‡» "Actions" æ ‡ç­¾
   - åº”è¯¥çœ‹åˆ°ä¸€ä¸ªæ–°çš„ workflow æ­£åœ¨è¿è¡Œ
   - ç‚¹å‡»è¿›å…¥æŸ¥çœ‹è¯¦ç»†è¿›åº¦

2. **ç­‰å¾…éƒ¨ç½²å®Œæˆ**
   - é€šå¸¸éœ€è¦ 5-10 åˆ†é’Ÿ
   - ç¡®ä¿æ‰€æœ‰æ­¥éª¤éƒ½æ˜¾ç¤ºç»¿è‰² âœ…

---

## ğŸŒ ç¬¬äº”æ­¥ï¼šé…ç½® Cloudflare Pages

### 5.1 åˆ›å»º Pages é¡¹ç›®

1. **è¿›å…¥ Pages é¡µé¢**
   - åœ¨ Cloudflare Dashboard å·¦ä¾§èœå•ç‚¹å‡» "Pages"
   - ç‚¹å‡» "Create a project"

2. **è¿æ¥ GitHub**
   - é€‰æ‹© "Connect to Git"
   - æˆæƒ Cloudflare è®¿é—®æ‚¨çš„ GitHub
   - é€‰æ‹© `sub-store` ä»“åº“

3. **é…ç½®æ„å»ºè®¾ç½®**
   ```
   Project name: sub-store-frontend
   Production branch: master
   Build command: cd frontend && npm run build
   Build output directory: frontend/dist
   Root directory: /
   ```

4. **ç¯å¢ƒå˜é‡**
   - ç‚¹å‡» "Environment variables"
   - æ·»åŠ ï¼š
     - `VITE_API_BASE_URL`: `https://sub-store-api.æ‚¨çš„ç”¨æˆ·å.workers.dev`

5. **å¼€å§‹éƒ¨ç½²**
   - ç‚¹å‡» "Save and Deploy"
   - ç­‰å¾…é¦–æ¬¡éƒ¨ç½²å®Œæˆ

---

## âœ… ç¬¬å…­æ­¥ï¼šéªŒè¯éƒ¨ç½²

### 6.1 æ£€æŸ¥ Workers

1. **è®¿é—® Workers é¡µé¢**
   - Cloudflare Dashboard â†’ "Workers & Pages"
   - åº”è¯¥çœ‹åˆ° `sub-store-api` Worker

2. **æµ‹è¯• API**
   - è®¿é—®ï¼š`https://sub-store-api.æ‚¨çš„ç”¨æˆ·å.workers.dev/health`
   - åº”è¯¥è¿”å›å¥åº·æ£€æŸ¥ JSON

### 6.2 æ£€æŸ¥ Pages

1. **è®¿é—® Pages é¡¹ç›®**
   - Cloudflare Dashboard â†’ "Pages"
   - ç‚¹å‡» `sub-store-frontend` é¡¹ç›®

2. **è·å–è®¿é—®åœ°å€**
   - å¤åˆ¶é¡¹ç›®çš„è®¿é—® URL
   - é€šå¸¸æ˜¯ï¼š`https://sub-store-frontend.pages.dev`

3. **æµ‹è¯•å‰ç«¯**
   - è®¿é—®å‰ç«¯åœ°å€
   - åº”è¯¥çœ‹åˆ° Sub-Store ç™»å½•é¡µé¢

### 6.3 æµ‹è¯•ç™»å½•

1. **ä½¿ç”¨ç®¡ç†å‘˜è´¦æˆ·ç™»å½•**
   - ç”¨æˆ·åï¼š`admin`
   - å¯†ç ï¼š`change_me_on_first_deploy`ï¼ˆé¦–æ¬¡ç™»å½•åéœ€è¦ä¿®æ”¹ï¼‰

2. **éªŒè¯åŠŸèƒ½**
   - æ£€æŸ¥èŠ‚ç‚¹ç®¡ç†åŠŸèƒ½
   - æµ‹è¯•ç»Ÿè®¡é¡µé¢
   - éªŒè¯æœç´¢åŠŸèƒ½

---

## ğŸ‰ éƒ¨ç½²å®Œæˆï¼

### è®¿é—®åœ°å€

- **å‰ç«¯ç®¡ç†ç•Œé¢**: https://sub-store-frontend.pages.dev
- **API æ¥å£**: https://sub-store-api.æ‚¨çš„ç”¨æˆ·å.workers.dev
- **å¥åº·æ£€æŸ¥**: https://sub-store-api.æ‚¨çš„ç”¨æˆ·å.workers.dev/health

### é»˜è®¤ç™»å½•ä¿¡æ¯

- **ç”¨æˆ·å**: `admin`
- **å¯†ç **: `change_me_on_first_deploy`

### ä¸‹ä¸€æ­¥

1. **ä¿®æ”¹é»˜è®¤å¯†ç **
2. **æ·»åŠ ä»£ç†èŠ‚ç‚¹**
3. **ç”Ÿæˆè®¢é˜…é“¾æ¥**
4. **äº«å—æ–°åŠŸèƒ½**

---

## ğŸ†˜ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **GitHub Actions å¤±è´¥**
   - æ£€æŸ¥ Secrets é…ç½®æ˜¯å¦æ­£ç¡®
   - ç¡®è®¤ API Token æƒé™è¶³å¤Ÿ

2. **D1 æ•°æ®åº“è¿æ¥å¤±è´¥**
   - ç¡®è®¤æ•°æ®åº“ ID é…ç½®æ­£ç¡®
   - æ£€æŸ¥è¡¨ç»“æ„æ˜¯å¦åˆ›å»ºæˆåŠŸ

3. **Pages éƒ¨ç½²å¤±è´¥**
   - æ£€æŸ¥æ„å»ºå‘½ä»¤å’Œè¾“å‡ºç›®å½•
   - ç¡®è®¤ç¯å¢ƒå˜é‡é…ç½®

### è·å–å¸®åŠ©

- ğŸ“– æŸ¥çœ‹é¡¹ç›®æ–‡æ¡£
- ğŸ› GitHub Issues åé¦ˆ
- ğŸ’¬ ç¤¾åŒºè®¨è®º

---

**ğŸŠ æ­å–œï¼æ‚¨å·²æˆåŠŸé€šè¿‡çº¯ç½‘é¡µæ“ä½œéƒ¨ç½²äº† Sub-Storeï¼**
